<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yangon TV - Pro Editor v6.9</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { background-color: #000000; color: #ffffff; font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 90px; }
        .header-sticky { position: sticky; top: 0; z-index: 999; background: rgba(0,0,0,0.95); backdrop-filter: blur(15px); border-bottom: 1px solid #334155; }
        .title-red { color: #ff0000; font-weight: 900; text-shadow: 0 0 10px rgba(239, 68, 68, 0.4); }
        .editor-box { background: #0a0a0a; border: 1px solid #1e293b; border-radius: 24px; }
        .line-wrapper { border-bottom: 1px solid #111827; padding: 14px 12px; }
        .line-input { background: transparent; border: none; outline: none; width: 100%; color: #f8fafc; font-size: 15px; }
        .error-glow { color: #ef4444 !important; font-weight: 600; background: rgba(239, 68, 68, 0.08); border-radius: 8px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(8px); }
        .modal-content { background-color: #0f172a; margin: 10% auto; padding: 25px; border: 1px solid #334155; width: 92%; max-width: 480px; border-radius: 30px; }
        .guide-card { background: #1e293b; padding: 16px; border-radius: 20px; margin-bottom: 12px; border-left: 5px solid #ef4444; }
        footer { position: fixed; bottom: 0; width: 100%; background: #000; border-top: 1px solid #1e293b; padding: 12px; z-index: 999; }
    </style>
</head>
<body>

    <div class="header-sticky">
        <div class="px-4 py-3 flex items-center justify-between max-w-xl mx-auto">
            <div class="flex items-center gap-3">
                <div class="bg-white w-10 h-10 rounded-full overflow-hidden flex items-center justify-center shadow-lg border border-zinc-800">
                    <img src="https://repgyetdcodkynrbxocg.supabase.co/storage/v1/object/public/images/telegram-1771253113148-de50b99c.jpg" alt="Logo" class="w-full h-full object-cover">
                </div>
                <h1 class="text-xl title-red tracking-tighter uppercase font-black italic">Yangon TV</h1>
            </div>
            <a href="dashboard.html" class="p-2.5 bg-zinc-900 border border-zinc-800 rounded-2xl active:scale-90 transition-all shadow-lg">
                <svg width="22" height="22" fill="none" stroke="#ef4444" stroke-width="2.5" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </a>
        </div>
        
        <div class="px-4 pb-4 max-w-xl mx-auto">
            <input type="file" id="fileInput" class="hidden" accept=".srt">
            <div class="grid grid-cols-3 gap-2">
                <button onclick="document.getElementById('fileInput').click()" class="bg-white text-black py-2.5 rounded-xl text-[11px] font-black uppercase">Upload</button>
                <button onclick="exportFile()" class="bg-zinc-900 border border-zinc-800 py-2.5 rounded-xl font-bold text-[11px] text-zinc-300">Save File</button>
                <button id="sendBtn" onclick="sendToTelegram()" class="bg-sky-500/10 border border-sky-500/30 py-2.5 rounded-xl font-bold text-[11px] text-sky-400 uppercase">Send Telegram</button>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
                <button onclick="autoCleanNoise()" class="bg-rose-950/50 border border-rose-800/60 py-3 rounded-xl font-black text-[10px] text-rose-500 uppercase tracking-widest">ğŸ§¹ 1-Touch Clean</button>
                <button onclick="scrollToNextError()" id="jumpBtn" class="bg-zinc-800 border border-zinc-700 py-3 rounded-xl font-black text-[10px] text-zinc-200 uppercase">Jump Next â†“</button>
            </div>
        </div>
    </div>

    <main class="max-w-xl mx-auto p-4"><div id="editor" class="editor-box p-2 min-h-[60vh] text-center py-40 text-zinc-800 text-[10px] uppercase font-bold tracking-[0.3em]">Waiting for file...</div></main>

    <footer><div class="max-w-xl mx-auto grid grid-cols-2 gap-3 px-2"><a href="https://t.me/+Z7RqOYn2KesyOTY9" class="bg-sky-600 text-white py-3.5 rounded-2xl text-center text-[12px] font-black uppercase">Team Chat</a><button onclick="openGuide()" class="bg-zinc-800 py-3.5 rounded-2xl text-[12px] font-black uppercase">User Guide</button></div></footer>

    <script>
        const BOT_TOKEN = '8069487397:AAHtsni-K1sFyOL1-MnvtooIYmEiZDohKYo';
        const CHAT_ID = '-1003745560690';
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbyoZTdhKIhBPVhJLJ9onp55iW46xH8rJ0B4plty0_5xRyArV_zBmFgQt_5UFV8if5nIpw/exec';

        const tg = window.Telegram.WebApp;
        let srtObjects = []; let fileName = ""; let errorIndices = []; let currentPointer = -1;

        document.getElementById('fileInput').addEventListener('change', e => {
            const file = e.target.files[0]; if(!file) return; fileName = file.name;
            const reader = new FileReader();
            reader.onload = ev => { processSRT(ev.target.result); renderEditor(); };
            reader.readAsText(file);
        });

        function processSRT(text) {
            srtObjects = text.trim().split(/\n\s*\n/).map(block => {
                const lines = block.split(/\r?\n/);
                return lines.length >= 3 ? { id: lines[0], time: lines[1], content: lines.slice(2).join('\n').trim() } : null;
            }).filter(o => o);
        }

        function renderEditor() {
            const editor = document.getElementById('editor'); editor.innerHTML = ''; errorIndices = [];
            srtObjects.forEach((obj, idx) => {
                const isErr = /[a-zA-Z]/.test(obj.content); if(isErr) errorIndices.push(idx);
                const div = document.createElement('div'); div.className = 'line-wrapper'; div.id = `line-${idx}`;
                div.innerHTML = `<div class="flex justify-between text-[9px] text-zinc-600 mb-2 uppercase font-mono"><span>${obj.time}</span><span class="${isErr?'text-rose-500':''}">â—</span></div>
                                 <input class="line-input ${isErr?'error-glow':''}" value="${obj.content}" oninput="srtObjects[${idx}].content=this.value; updateStatusText()">`;
                editor.appendChild(div);
            });
            updateStatusText();
        }

        function updateStatusText() {
            const errs = srtObjects.filter(o => /[a-zA-Z]/.test(o.content)).length;
            document.getElementById('jumpBtn').innerText = `Jump Next (${errs}) â†“`;
        }

        async function sendToTelegram() {
            if(!srtObjects.length) return;
            const btn = document.getElementById('sendBtn'); btn.innerText = "..."; btn.disabled = true;

            const senderName = tg.initDataUnsafe?.user?.first_name || "Unknown";
            let movieTitle = "Unknown Movie", finalName = `Fixed_${fileName}`;
            let match = fileName.match(/(.*?)(?:s)?(\d+)(?:e|ep)(\d+)/i);
            if(match) {
                movieTitle = match[1].replace(/[^a-zA-Z0-9]/g,' ').trim().toUpperCase();
                finalName = `${movieTitle.replace(/\s+/g,'')}_S${match[2]}_EP${match[3]}_fixedby_${senderName}.srt`;
            }

            let out = srtObjects.map((o,i) => `${i+1}\r\n${o.time}\r\n${o.content}\r\n\r\n`).join('');
            const fd = new FormData();
            fd.append('chat_id', CHAT_ID);
            fd.append('document', new Blob([out], {type:'text/plain'}), finalName);
            fd.append('caption', `${movieTitle}\nğŸ‘¤ - ${senderName}\nSuccess âœ…`);

            try {
                const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`, { method: 'POST', body: fd });
                if(res.ok) {
                    btn.innerText = "SENT âœ…";
                    fetch(BACKEND_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({
                        userId: tg.initDataUnsafe?.user?.id || 'Unknown',
                        userName: senderName, fileName: finalName, movieTitle: movieTitle, srtContent: out
                    })});
                    saveToLocal(finalName);
                } else throw Error();
            } catch(e) { btn.innerText = "FAIL âŒ"; }
            setTimeout(() => { btn.innerText = "Telegram"; btn.disabled = false; }, 2000);
        }

        function saveToLocal(name) {
            let h = JSON.parse(localStorage.getItem('ytv_user_history') || "[]");
            h.push({ name: name, date: new Date().toLocaleString(), status: 'Success' });
            localStorage.setItem('ytv_user_history', JSON.stringify(h.slice(-15)));
            localStorage.setItem('ytv_user_count', (parseInt(localStorage.getItem('ytv_user_count') || "0") + 1).toString());
        }

        function autoCleanNoise() {
            srtObjects = srtObjects.filter(o => /[\u1000-\u109F]/.test(o.content));
            renderEditor(); tg.HapticFeedback.notificationOccurred('success');
        }

        function scrollToNextError() {
            const errs = srtObjects.map((o,i) => /[a-zA-Z]/.test(o.content)?i:null).filter(v => v!==null);
            if(!errs.length) return; currentPointer = (currentPointer + 1) % errs.length;
            const el = document.getElementById(`line-${errs[currentPointer]}`);
            window.scrollTo({ top: el.offsetTop - 180, behavior: 'smooth' });
        }
        
        function openGuide() { document.getElementById('guideModal').style.display="block"; }
        function closeGuide() { document.getElementById('guideModal').style.display="none"; }
        function exportFile() {
            let out = srtObjects.map((o,i) => `${i+1}\r\n${o.time}\r\n${o.content}\r\n\r\n`).join('');
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([out])); a.download = "Fixed_"+fileName; a.click();
        }
    </script>

    <div id="guideModal" class="modal">
        <div class="modal-content animate-in zoom-in duration-300">
            <h2 class="text-rose-500 font-black text-2xl uppercase mb-6 italic tracking-tighter">User Guide</h2>
            <div class="space-y-4 max-h-[50vh] overflow-y-auto pr-2 text-left">
                <div class="guide-card">
                    <h3 class="text-[13px] font-black text-rose-400 mb-1 uppercase">Strict Cleaning</h3>
                    <p class="text-[11px] text-zinc-400 leading-relaxed">1-Touch Clean á€€á€­á€¯ á€”á€¾á€­á€•á€ºá€œá€­á€¯á€€á€ºá€›á€„á€º á€™á€¼á€”á€ºá€™á€¬á€…á€¬ (Unicode Range \u1000-\u109F) á€á€…á€ºá€œá€¯á€¶á€¸á€™á€¾ á€™á€•á€«á€á€²á€· á€˜á€šá€ºá€œá€­á€¯á€„á€ºá€¸á€™á€†á€­á€¯ á€¡á€€á€¯á€”á€º á€–á€»á€€á€ºá€‘á€¯á€á€ºá€•á€±á€¸á€™á€¾á€¬á€•á€«á‹ á€’á€«á€€á€¼á€±á€¬á€„á€·á€º á€á€›á€¯á€á€ºá€…á€¬áŠ á€‚á€»á€•á€”á€ºá€…á€¬ á€’á€«á€™á€¾á€™á€Ÿá€¯á€á€º Symbols á€á€½á€±á€•á€«á€á€²á€· Noise á€œá€­á€¯á€„á€ºá€¸á€á€½á€± á€¡á€€á€¯á€”á€º á€•á€¼á€¯á€á€ºá€á€½á€¬á€¸á€•á€«á€™á€šá€ºá‹</p>
                </div>
                <div class="guide-card">
                    <h3 class="text-[13px] font-black text-rose-400 mb-1 uppercase">Smart Highlighting</h3>
                    <p class="text-[11px] text-zinc-400 leading-relaxed">á€™á€¼á€”á€ºá€™á€¬á€…á€¬ á€•á€«á€•á€±á€™á€²á€· á€¡á€„á€ºá€¹á€‚á€œá€­á€•á€ºá€…á€¬á€œá€¯á€¶á€¸ á€Šá€•á€ºá€•á€«á€”á€±á€á€²á€· á€œá€­á€¯á€„á€ºá€¸á€á€½á€±á€€á€­á€¯á€á€±á€¬á€· Jump á€•á€¼á€¯á€œá€¯á€•á€ºá€–á€­á€¯á€· "âš ï¸ Check Context" á€†á€­á€¯á€•á€¼á€®á€¸ á€¡á€”á€®á€›á€±á€¬á€„á€ºá€•á€¼á€•á€±á€¸á€‘á€¬á€¸á€™á€¾á€¬á€•á€«á‹</p>
                </div>
                <div class="guide-card">
                    <h3 class="text-[13px] font-black text-rose-400 mb-1 uppercase">Real-time Update</h3>
                    <p class="text-[11px] text-zinc-400 leading-relaxed">á€…á€¬á€á€¬á€¸á€á€½á€±á€€á€­á€¯ á€•á€¼á€„á€ºá€œá€­á€¯á€€á€ºá€á€¬á€”á€²á€· Error count á€€ á€¡á€œá€­á€¯á€¡á€œá€»á€±á€¬á€€á€º á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€½á€¬á€¸á€™á€¾á€¬ á€–á€¼á€…á€ºá€•á€«á€á€šá€ºá‹</p>
                </div>
            </div>
            <button onclick="closeGuide()" class="w-full bg-rose-600 py-4 rounded-2xl mt-6 font-black text-sm uppercase">Understood</button>
        </div>
    </div>
</body>
</html>